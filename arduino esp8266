#include <ESP8266WiFi.h>
#include <OneWire.h>
#include <DallasTemperature.h>

/* ----------- WIFI ---------- */
const char* ssid = "GALAXY A52A200";
const char* password = "111188647";

/* ----------- DS18B20 ---------- */
// GPIO4 = D2 sur NodeMCU
#define ONE_WIRE_BUS D2
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);


#define PIN_ANALOG A0

WiFiServer server(80);

void setup() {
  Serial.begin(115200);
  delay(500);

  // Initialisation du capteur DS18B20
  sensors.begin();

  // Connexion WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connexion WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nCarte connectée");
  Serial.print("IP : ");
  Serial.println(WiFi.localIP());

  randomSeed(analogRead(A0));

  server.begin();
  Serial.println("Serveur HTTP démarré");
}

void loop() {

  /* ----------- Lecture capteurs ---------- */
  sensors.requestTemperatures();
  float temperature = sensors.getTempCByIndex(0);

  int rawAnalog = analogRead(PIN_ANALOG);

  // Exemple de conversion (à adapter selon ton capteur réel)
  float current = (rawAnalog / 1023.0) * 3.3;   // Courant simulé
  float voltage = (rawAnalog / 1023.0) * 11.0;  // Tension simulée

  int rotation = random(800, 3000);

  /* ----------- LIGNE 1 ---------- */
  String etat = (WiFi.status() == WL_CONNECTED) ? "Connectee" : "Non connectee";

  String ligne1 = "IP: " + WiFi.localIP().toString() +
                  " | Etat: " + etat;

  /* ----------- LIGNE 2 ---------- */
  String ligne2 = "Temperature: " + String(temperature, 2) + " C\n" +
                  "Courant: " + String(current, 2) + " A\n" +
                  "Tension: " + String(voltage, 2) + " V\n" +
                  "Rotation: " + String(rotation) + " RPM";

  /* ----------- Serveur Web ---------- */
  WiFiClient client = server.available();
  if (!client) return;

  while (!client.available()) delay(1);
  client.readStringUntil('\r');

  client.println("HTTP/1.1 200 OK");
  client.println("Content-Type: text/plain; charset=utf-8");
  client.println("Connection: close");
  client.println();

  // Format idéal pour App Inventor / Python / Processing
  client.println(ligne1);
  client.println("###");
  client.println(ligne2);

  delay(500);
}
